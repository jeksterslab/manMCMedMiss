---
title: "Benchmark: The Simple Mediation Model with Missing Data using semmcci vs. Nonparametric Bootstrap in lavaan"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-18"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: The Simple Mediation Model with Missing Data using semmcci vs. Nonparametric Bootstrap in lavaan}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---









We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with missing data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)

# Create data set with missing values.

miss <- sample(1:dim(df)[1], 300)
df[miss[1:100], "X"] <- NA
df[miss[101:200], "M"] <- NA
df[miss[201:300], "Y"] <- NA
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.
We are using `missing = "fiml"` to handle missing data in `lavaan`.
Since there are missing values in `x`, we also set `fixed.x = FALSE`.


```r
fit <- sem(data = df, model = model, missing = "fiml", fixed.x = FALSE)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 5000L, alpha = c(0.001, 0.01, 0.05))
#> Monte Carlo Confidence Intervals
#>              est     se    R   0.05%    0.5%    2.5%  97.5%  99.5% 99.95%
#> cp        0.2335 0.0298 5000  0.1360  0.1567  0.1755 0.2927 0.3096 0.3313
#> b         0.5112 0.0295 5000  0.4220  0.4353  0.4527 0.5695 0.5872 0.6034
#> a         0.4809 0.0291 5000  0.3929  0.4057  0.4236 0.5393 0.5563 0.5776
#> Y~~Y      0.5542 0.0268 5000  0.4760  0.4857  0.5005 0.6062 0.6237 0.6431
#> M~~M      0.7564 0.0363 5000  0.6426  0.6607  0.6843 0.8281 0.8493 0.8757
#> X~~X      1.0591 0.0500 5000  0.9076  0.9343  0.9629 1.1583 1.1914 1.2327
#> Y~1      -0.0127 0.0252 5000 -0.0993 -0.0769 -0.0623 0.0366 0.0534 0.0696
#> M~1      -0.0223 0.0287 5000 -0.1179 -0.0962 -0.0787 0.0347 0.0538 0.0731
#> X~1       0.0025 0.0343 5000 -0.1115 -0.0884 -0.0654 0.0671 0.0878 0.1118
#> indirect  0.2458 0.0202 5000  0.1866  0.1979  0.2077 0.2867 0.2995 0.3155
#> direct    0.2335 0.0298 5000  0.1360  0.1567  0.1755 0.2927 0.3096 0.3313
#> total     0.4794 0.0291 5000  0.3868  0.4018  0.4215 0.5360 0.5521 0.5696
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = 5000L
  )
)
#>         lhs op      rhs    label    est    se      z pvalue ci.lower ci.upper
#> 1         Y  ~        X       cp  0.234 0.030  7.827  0.000    0.175    0.293
#> 2         Y  ~        M        b  0.511 0.031 16.692  0.000    0.450    0.570
#> 3         M  ~        X        a  0.481 0.028 16.969  0.000    0.427    0.536
#> 4         Y ~~        Y           0.554 0.027 20.640  0.000    0.501    0.606
#> 5         M ~~        M           0.756 0.037 20.498  0.000    0.684    0.827
#> 6         X ~~        X           1.059 0.053 20.145  0.000    0.959    1.166
#> 7         Y ~1                   -0.013 0.026 -0.497  0.619   -0.063    0.039
#> 8         M ~1                   -0.022 0.029 -0.768  0.442   -0.078    0.034
#> 9         X ~1                    0.002 0.034  0.074  0.941   -0.063    0.068
#> 10 indirect :=      a*b indirect  0.246 0.020 12.015  0.000    0.207    0.285
#> 11   direct :=       cp   direct  0.234 0.030  7.826  0.000    0.175    0.293
#> 12    total := cp+(a*b)    total  0.479 0.029 16.390  0.000    0.421    0.537
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |5000   |Number of Monte Carlo replications. |
|B         |5000   |Number of bootstrap samples.        |






```r
benchmark01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model,
      missing = "fiml",
      fixed.x = FALSE
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark01, unit = "ms")
#>   expr        min          lq        mean      median          uq         max
#> 1   MC    173.833    205.2419    227.2141    222.5822    250.5154    274.4581
#> 2   NB 110619.112 111489.4273 112113.8404 111927.0876 113015.0124 113919.6178
#>   neval cld
#> 1    10  a 
#> 2    10   b
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark01, unit = "relative")
#>   expr      min       lq     mean   median       uq     max neval cld
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.000    10  a 
#> 2   NB 636.3527 543.2098 493.4282 502.8573 451.1301 415.071    10   b
```

### Plot

<img src="fig-vignettes-benchmark-semmcci-unnamed-chunk-17-1.png" width="3300" /><img src="fig-vignettes-benchmark-semmcci-unnamed-chunk-17-2.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model,
  missing = "fiml",
  fixed.x = FALSE
)
benchmark02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark02, unit = "ms")
#>   expr         min          lq        mean      median          uq         max
#> 1   MC    118.1595    121.2965    123.1068    122.9263    125.7505    129.4889
#> 2   NB 110678.8702 111070.3404 112020.7645 112106.5329 113007.7071 113404.1493
#>   neval cld
#> 1    10  a 
#> 2    10   b
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark02, unit = "relative")
#>   expr      min       lq     mean   median      uq      max neval cld
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.000   1.0000    10  a 
#> 2   NB 936.6905 915.6931 909.9477 911.9814 898.666 875.7829    10   b
```

### Plot

<img src="fig-vignettes-benchmark-semmcci-unnamed-chunk-22-1.png" width="3300" /><img src="fig-vignettes-benchmark-semmcci-unnamed-chunk-22-2.png" width="3300" />
